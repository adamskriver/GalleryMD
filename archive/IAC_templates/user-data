#cloud-config
# TEMPLATE: Ubuntu Hyper-V VM with Autoinstall
# Replace <USERNAME>, <SSH_KEY>, <PASSWORD_HASH>, <HOSTNAME>, etc. as needed

# CRITICAL: Use autoinstall for unattended Ubuntu installation on Hyper-V
autoinstall:
  version: 1
  interactive-sections: []  # Skip all interactive steps - REQUIRED for Hyper-V
  early-commands:
    # CRITICAL: Prevent package installation prompts
    - echo 'debconf debconf/frontend select noninteractive' | debconf-set-selections
  
  locale: en_US
  keyboard:
    layout: us
    
  identity:
    hostname: <HOSTNAME>
    username: <USERNAME>
    # Generate password hash with: openssl passwd -6 -salt $(openssl rand -base64 16) <PASSWORD>
    password: "<PASSWORD_HASH>"
  
  # REQUIRED: Storage configuration for Hyper-V
  storage:
    layout:
      name: direct
  
  # SSH configuration
  ssh:
    install-server: true
    allow-pw: true
    ssh_authorized_keys:
      - <SSH_KEY>
    
  # REQUIRED: Network setup for Hyper-V DHCP
  network:
    version: 2
    ethernets:
      eth0:
        dhcp4: true

  # Add your packages here
  packages:
    - curl
    - git
    # - Add more packages as needed

  late-commands:
    # CRITICAL: Ensure non-interactive mode persists after installation
    - echo 'debconf debconf/frontend select noninteractive' | chroot /target debconf-set-selections
    # Add your custom setup commands here
    - echo "<HOSTNAME> VM setup completed at $(date)" > /target/var/log/<HOSTNAME>-setup.log
    # Enable any services you installed
    # - curtin in-target --target=/target -- systemctl enable <service-name>

  # RECOMMENDED: Reboot after installation
  reboot: true
