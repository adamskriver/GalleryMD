services:
  # GalleryMD Application
  gallerymd:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: gallerymd
    restart: unless-stopped
    ports:
      - "3003:3003"
    environment:
      - PORT=3003
      - MD_ROOT=/docs
      - SCAN_INTERVAL=300000
      - RATE_LIMIT_WINDOW=60000
      - MAX_REQUESTS=100
      - CACHE_MAX_AGE=3600
      - ALLOWED_ORIGINS=*
      - ADMIN_TOKEN=${ADMIN_TOKEN}
    volumes:
      # Only mount volume if MD_ROOT_HOST is set (skips mount in CI)
      - ${MD_ROOT_HOST:-./docs}:/docs:ro
    networks:
      - gallerymd-network
    healthcheck:
      test: ["CMD", "deno", "eval", "fetch('http://localhost:3003/api/status').then(r => r.ok ? Deno.exit(0) : Deno.exit(1)).catch(() => Deno.exit(1))"]
      interval: 30s
      timeout: 3s
      start_period: 5s
      retries: 3

  # GitHub Actions Self-Hosted Runner
  runner:
    image: myoung34/github-runner:latest
    container_name: gallerymd-runner
    restart: unless-stopped
    environment:
      - REPO_URL=https://github.com/${REPO}
      - RUNNER_NAME=${RUNNER_NAME:-gallerymd-runner}
      # Use PAT if available, otherwise fall back to RUNNER_TOKEN
      - ACCESS_TOKEN=${GITHUB_PAT:-}
      - RUNNER_TOKEN=${RUNNER_TOKEN:-}
      - RUNNER_WORKDIR=${RUNNER_WORKDIR:-/tmp/runner}
      - LABELS=${LABELS:-self-hosted,docker,linux}
      - RUNNER_SCOPE=${RUNNER_SCOPE:-repo}
      - DISABLE_AUTO_UPDATE=true
      - EPHEMERAL=${EPHEMERAL:-false}
    volumes:
      - runner_work:/tmp/runner
      - runner_config:/home/docker/.runner
      - /var/run/docker.sock:/var/run/docker.sock  # Docker-in-Docker for workflows
    networks:
      - gallerymd-network
    depends_on:
      - gallerymd

networks:
  gallerymd-network:
    driver: bridge

volumes:
  runner_work:
    driver: local
  runner_config:
    driver: local
