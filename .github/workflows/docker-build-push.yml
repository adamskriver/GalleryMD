name: Deploy GalleryMD

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allows manual triggering

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create .env for deployment
        run: |
          # Create .env with required configuration
          # MD_ROOT_HOST points to the path mounted in the runner container
          cat > .env << 'EOF'
          REPO=adamskriver/GalleryMD
          RUNNER_NAME=gallerymd-runner
          LABELS=self-hosted,docker,linux
          RUNNER_WORKDIR=/tmp/runner
          RUNNER_SCOPE=repo
          MD_ROOT_HOST=/mnt/casestudies
          ADMIN_TOKEN=${{ secrets.ADMIN_TOKEN }}
          EOF
          
          echo "✓ Created .env file with MD_ROOT_HOST configuration"
      
      - name: Deploy with Docker Compose
        run: |
          # Stop and remove existing container if it exists
          docker compose down gallerymd || true
          
          # Rebuild and restart the gallerymd service
          # .env file (git-ignored) contains MD_ROOT_HOST for local path mounting
          docker compose build gallerymd
          docker compose up -d gallerymd
          
          echo "✓ GalleryMD deployed successfully"
      
      - name: Verify deployment
        run: |
          sleep 3
          docker compose ps
          docker compose logs --tail=20 gallerymd
          echo "✓ Deployment complete!"
      
      - name: Cleanup
        if: always()
        run: |
          rm -f .env