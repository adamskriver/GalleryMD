name: Deploy GalleryMD

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allows manual triggering

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create .env with secrets
        run: |
          # Inject GitHub secrets into .env for deployment
          echo "ADMIN_TOKEN=${{ secrets.ADMIN_TOKEN }}" >> .env.deploy
          
      - name: Deploy with Docker Compose
        run: |
          # Rebuild and restart only the gallerymd service
          docker compose build gallerymd
          docker compose up -d gallerymd
          
          echo "✓ GalleryMD deployed successfully"
      
      - name: Verify deployment
        run: |
          sleep 3
          docker compose ps
          docker compose logs --tail=20 gallerymd
          echo "✓ Deployment complete!"
      
      - name: Cleanup
        if: always()
        run: |
          rm -f .env.deploy