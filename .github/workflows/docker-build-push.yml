name: Docker Build and Push

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allows manual triggering

jobs:
  build-and-push:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build Docker image locally
        run: |
          docker build -t gallerymd-deno:latest .
          echo "✓ Docker image built successfully"
      
      - name: Show image info
        run: |
          docker images gallerymd-deno:latest
      
      - name: Restart gallerymd container
        run: |
          echo "Stopping existing gallerymd container (if running)..."
          docker stop gallerymd || true
          docker rm gallerymd || true
          
          echo "Starting new gallerymd container..."
          docker run -d \
            --name gallerymd \
            --restart unless-stopped \
            -p 3003:3003 \
            -v 'Z:/Nineriver Technologies/Dev:/docs' \
            -e MD_ROOT=/docs \
            gallerymd-deno:latest
          
          echo "✓ Container restarted with updated image"
      
      - name: Verify container is running
        run: |
          sleep 3
          docker ps --filter "name=gallerymd" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          echo "✓ Deployment complete!"